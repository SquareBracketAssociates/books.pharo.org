<!DOCTYPE html>
<html>
  <head>
    <title></title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="shortcut icon" href="images/favicon.png" type="image/x-icon" />
<link href="/booklet-Smacc/html/_support/html/css/font-awesome.min.css" rel="stylesheet">
<link href="/booklet-Smacc/html/_support/html/css/nucleus.css" rel="stylesheet">
<link href="/booklet-Smacc/html/_support/html/css/flex.css" rel="stylesheet">
<link rel="stylesheet" href="/booklet-Smacc/html/_support/html/highlightjs/styles/default.css">
<link rel="stylesheet" href="/booklet-Smacc/html/_support/html/css/highlight-commands.css">
<link rel="stylesheet" href="/booklet-Smacc/html/_support/html/css/bootstrap.min.css">
<script src="/booklet-Smacc/html/_support/html/js/jquery-2.x.min.js"></script>
<script src="/booklet-Smacc/html/_support/html/highlightjs/highlight.pack.js"></script>
<script src="/booklet-Smacc/html/_support/html/js/highlight-commands.js"></script>
<meta name="description" content="">
<meta name="author" content="John Brant, Jason Lecerf,  Thierry Goubier, StÃ©phane Ducasse, and Andrew Black">
  </head>
  <body>
    <header>
  <div class="logo">
    <a class="baselink" href="/booklet-Smacc/html"></a>
  </div>
  <div class="burger"><a href="javascript:void(0);" style="font-size:15px;">&#9776;</a></div>
  
</header>
<article>
  <aside>
    <ul class="menu">
   		<li data-nav-id="123" class="dd-item">
    		<a href="/booklet-Smacc/html">
		       <i class="fa fa-fw fa-home"></i>
	    	</a>
        </li>

		
		  <li class="dd-item  haschildren ">
			<div>
			  <a href="/booklet-Smacc/html/Chapters/Smacc/SmaccIntro.html#about this booklet">
					About this Booklet
			  </a>
			   <i class="fa fa-angle-right fa-lg category-icon"></i> 
			</div>
			  <ul class="dd-item">
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccIntro.html#contents">
							Contents
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccIntro.html#obtaining smacc">
							Obtaining SmaCC
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccIntro.html#basics">
							Basics
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
			  </ul>
		  
		  </li>
		
		  <li class="dd-item  haschildren ">
			<div>
			  <a href="/booklet-Smacc/html/Chapters/Smacc/SmaccTutorial.html#a first smacc tutorial">
					A First SmaCC Tutorial
			  </a>
			   <i class="fa fa-angle-right fa-lg category-icon"></i> 
			</div>
			  <ul class="dd-item">
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccTutorial.html#opening the tools">
							Opening the Tools
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item  haschildren ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccTutorial.html#first, the scanner">
							First, the Scanner
						</a>
						<i class="fa fa-angle-right fa-lg category-icon"></i>
					</div>

					<ul class="dd-item">
							
						<li class="dd-item">
							<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccTutorial.html#ignoring whitespace">Ignoring Whitespace</a>
						</li>
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccTutorial.html#second, the calculator grammar">
							Second, the Calculator Grammar
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccTutorial.html#compile the scanner and the parser">
							Compile the Scanner and the Parser
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccTutorial.html#testing our parser">
							Testing our Parser
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccTutorial.html#defining actions">
							Defining Actions
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccTutorial.html#named expressions">
							Named Expressions
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccTutorial.html#extending the language">
							Extending the Language
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccTutorial.html#handling priority">
							Handling Priority
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccTutorial.html#handling priority with directives">
							Handling Priority with Directives
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
			  </ul>
		  
		  </li>
		
		  <li class="dd-item  haschildren ">
			<div>
			  <a href="/booklet-Smacc/html/Chapters/Smacc/SmaccScanner.html#smacc scanner">
					SmaCC Scanner
			  </a>
			   <i class="fa fa-angle-right fa-lg category-icon"></i> 
			</div>
			  <ul class="dd-item">
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccScanner.html#regular expression syntax">
							Regular Expression Syntax
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccScanner.html#overlapping tokens">
							Overlapping Tokens
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccScanner.html#token action methods">
							Token Action Methods
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccScanner.html#unreferenced tokens">
							Unreferenced Tokens
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccScanner.html#unicode characters">
							Unicode Characters
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
			  </ul>
		  
		  </li>
		
		  <li class="dd-item  haschildren ">
			<div>
			  <a href="/booklet-Smacc/html/Chapters/Smacc/SmaccParser.html#smacc parser">
					SmaCC Parser
			  </a>
			   <i class="fa fa-angle-right fa-lg category-icon"></i> 
			</div>
			  <ul class="dd-item">
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccParser.html#production rules">
							Production Rules
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccParser.html#named symbols">
							Named Symbols
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccParser.html#error recovery">
							Error Recovery
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccParser.html#shortcuts">
							Shortcuts
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
			  </ul>
		  
		  </li>
		
		  <li class="dd-item  haschildren ">
			<div>
			  <a href="/booklet-Smacc/html/Chapters/Smacc/SmaccDirectives.html#smacc directives">
					SmaCC Directives
			  </a>
			   <i class="fa fa-angle-right fa-lg category-icon"></i> 
			</div>
			  <ul class="dd-item">
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccDirectives.html#start symbols">
							Start Symbols
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccDirectives.html#id methods">
							Id Methods
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccDirectives.html#case insensitive scanning">
							Case Insensitive Scanning
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccDirectives.html#ast directives">
							AST Directives
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item  haschildren ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccDirectives.html#dealing with ambiguous grammars">
							Dealing with Ambiguous Grammars
						</a>
						<i class="fa fa-angle-right fa-lg category-icon"></i>
					</div>

					<ul class="dd-item">
							
						<li class="dd-item">
							<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccDirectives.html#lr, lalr and ambiguous grammars">LR, LALR and Ambiguous Grammars</a>
						</li>
							
						<li class="dd-item">
							<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccDirectives.html#precedence rules">Precedence Rules</a>
						</li>
							
						<li class="dd-item">
							<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccDirectives.html#glr parsing">GLR Parsing</a>
						</li>
					
					</ul>						
				</li>
				
			  </ul>
		  
		  </li>
		
		  <li class="dd-item  haschildren ">
			<div>
			  <a href="/booklet-Smacc/html/Chapters/Smacc/SmaccAST.html#smacc abstract syntax trees">
					SmaCC Abstract Syntax Trees
			  </a>
			   <i class="fa fa-angle-right fa-lg category-icon"></i> 
			</div>
			  <ul class="dd-item">
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccAST.html#restarting">
							Restarting
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccAST.html#building nodes ">
							Building Nodes 
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccAST.html#variables and unnamed entities">
							Variables and Unnamed Entities
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccAST.html#unnamed symbols">
							Unnamed Symbols
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccAST.html#generating the ast">
							Generating the AST
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccAST.html#ast comparison">
							AST Comparison
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccAST.html#extending the visitor">
							Extending the Visitor
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
			  </ul>
		  
		  </li>
		
		  <li class="dd-item  haschildren ">
			<div>
			  <a href="/booklet-Smacc/html/Chapters/Smacc/SmaccAdvanced.html#advanced features of smacc">
					Advanced Features of SmaCC
			  </a>
			   <i class="fa fa-angle-right fa-lg category-icon"></i> 
			</div>
			  <ul class="dd-item">
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccAdvanced.html#multi-state scanners">
							Multi-state Scanners
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item  haschildren ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccAdvanced.html#indentation-sensitive parsing">
							Indentation-Sensitive Parsing
						</a>
						<i class="fa fa-angle-right fa-lg category-icon"></i>
					</div>

					<ul class="dd-item">
							
						<li class="dd-item">
							<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccAdvanced.html#using token actions to customize the scanner">Using Token Actions to Customize the Scanner</a>
						</li>
							
						<li class="dd-item">
							<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccAdvanced.html#using newlines to separate statements">Using Newlines to Separate Statements</a>
						</li>
							
						<li class="dd-item">
							<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccAdvanced.html#augmenting the state of the scanner">Augmenting the State of the Scanner</a>
						</li>
							
						<li class="dd-item">
							<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccAdvanced.html#unnamed tokens">Unnamed Tokens</a>
						</li>
							
						<li class="dd-item">
							<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccAdvanced.html#closing blocks">Closing Blocks</a>
						</li>
							
						<li class="dd-item">
							<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccAdvanced.html#continuation lines">Continuation Lines</a>
						</li>
							
						<li class="dd-item">
							<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccAdvanced.html#ignoring blank lines">Ignoring Blank Lines</a>
						</li>
							
						<li class="dd-item">
							<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccAdvanced.html#the rest of the story">The Rest of the Story</a>
						</li>
					
					</ul>						
				</li>
				
			  </ul>
		  
		  </li>
		
		  <li class="dd-item  haschildren ">
			<div>
			  <a href="/booklet-Smacc/html/Chapters/Smacc/SmaccTransformations.html#smacc transformations">
					SmaCC Transformations
			  </a>
			   <i class="fa fa-angle-right fa-lg category-icon"></i> 
			</div>
			  <ul class="dd-item">
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccTransformations.html#defining transformations ">
							Defining Transformations 
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccTransformations.html#pattern matching expressions">
							Pattern matching Expressions
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccTransformations.html#example">
							Example
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccTransformations.html#parametrizing transformations">
							Parametrizing Transformations
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccTransformations.html#restrictions and limitations">
							Restrictions and Limitations
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
			  </ul>
		  
		  </li>
		
		  <li class="dd-item  haschildren ">
			<div>
			  <a href="/booklet-Smacc/html/Chapters/Smacc/SmaccIdioms.html#grammar idioms">
					Grammar Idioms
			  </a>
			   <i class="fa fa-angle-right fa-lg category-icon"></i> 
			</div>
			  <ul class="dd-item">
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccIdioms.html#managing lists">
							Managing Lists
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccIdioms.html#using shortcuts">
							Using Shortcuts
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccIdioms.html#expressing optional features">
							Expressing Optional Features
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
			  </ul>
		  
		  </li>
		
		  <li class="dd-item ">
			<div>
			  <a href="/booklet-Smacc/html/Chapters/Smacc/SmaccConclusion.html#conclusion">
					Conclusion
			  </a>
			  
			</div>
			  <ul class="dd-item">
				
			  </ul>
		  
		  </li>
		
		  <li class="dd-item  haschildren ">
			<div>
			  <a href="/booklet-Smacc/html/Chapters/Smacc/SmaccVocabulary.html#vocabulary">
					Vocabulary
			  </a>
			   <i class="fa fa-angle-right fa-lg category-icon"></i> 
			</div>
			  <ul class="dd-item">
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccVocabulary.html#reference example ">
							Reference Example 
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccVocabulary.html#metagrammar structure">
							Metagrammar structure
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item  haschildren ">
					<div>
						<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccVocabulary.html#elements ">
							Elements 
						</a>
						<i class="fa fa-angle-right fa-lg category-icon"></i>
					</div>

					<ul class="dd-item">
							
						<li class="dd-item">
							<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccVocabulary.html#production rule">Production rule</a>
						</li>
							
						<li class="dd-item">
							<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccVocabulary.html#tokens">Tokens</a>
						</li>
							
						<li class="dd-item">
							<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccVocabulary.html#keywords">Keywords</a>
						</li>
							
						<li class="dd-item">
							<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccVocabulary.html#non terminal">Non Terminal</a>
						</li>
							
						<li class="dd-item">
							<a href="/booklet-Smacc/html/Chapters/Smacc/SmaccVocabulary.html#variables">Variables</a>
						</li>
					
					</ul>						
				</li>
				
			  </ul>
		  
		  </li>
		
    </ul>
  </aside>

  <section class="page">
    
	<h1>Smacc: a Compiler-Compiler</h1>
		
	<h2>SmaCC Transformations</h2>


<p>
Once you have generated a parser for your language, you can use SmaCC to transform programs written in your language.
Note that the output from the transformation phase is the text of a program (which may be in the input language or another language) and not a parse tree.
</p>

<h3>Defining Transformations </h3>

<p>
Let's add support for transforming the simple expression language of our calculator example.
The basic idea is to define <em>patterns</em> that match subtrees of the grammar, and specify how these subtrees should be rewritten.
</p>
<p>
We start by extending our grammar with two additional lines.
</p>
<p>
The first line defines how we will write a pattern in our grammar.
SmaCC has a small built-in pattern syntax: it is in fact the language of your grammar plus metavariables.
Metavariables will hold the matching subtree after the pattern matching part of the transformation.
To identify a metavariable, your scanner should define the <code>&lt;patternToken&gt;</code>: SmaCC uses this token to define metavariables.
For our example language, we will define a metavariable as anything enclosed by <code>`</code> characters (e.g., <code>`pattern`</code>).
Note that this token, despite its special behaviour, is still valid in the scanner and thus should not conflict with other token definitions.
</p>
<p>
The second line we need to add tells SmaCC to generate a GLR parser (<code>%glr;</code>).
This allows SmaCC to parse <em>all possible</em> representations of a pattern expression, rather than just one.
</p>
<p>
Here is our grammar with these two additions.
</p>
<figure><pre><code>	&lt;number&gt; : [0-9]+ (\. [0-9]*) ? ;
	&lt;name&gt; : [a-zA-Z]\w*;
	&lt;whitespace&gt; : \s+;

+	&lt;patternToken&gt; : \` [^\`]* \` ;
+	%glr;

	%left &quot;+&quot; &quot;-&quot;;
	%left &quot;*&quot; &quot;/&quot;;
	%right &quot;^&quot;;

	%annotate_tokens;
	%root Expression;
	%prefix AST;
	%suffix Node;
	%ignore_variables leftParenToken rightParenToken;

	Expression 
		: Expression 'left' &quot;+&quot; 'operator' Expression 'right' {{Binary}}
		| Expression 'left' &quot;-&quot; 'operator' Expression 'right' {{Binary}}
		| Expression 'left' &quot;*&quot; 'operator' Expression 'right' {{Binary}}
		| Expression 'left' &quot;/&quot; 'operator' Expression 'right' {{Binary}}
		| Expression 'left' &quot;^&quot; 'operator' Expression 'right' {{Binary}}
		| &quot;(&quot; Expression &quot;)&quot; {{}}
		| Number
		| Function
        ;

	Number
        : &lt;number&gt; {{Number}}
        ;

	Function
		: &lt;name&gt; &quot;(&quot; 'leftParen' (Expression 'argument' (&quot;,&quot; Expression 'argument')* )? &quot;)&quot; 'rightParen' {{}}
        ;</code></pre><figcaption></figcaption></figure>

<p>
And that is the only two things you need to do to activate the Rewrite Engine for your new language.
</p>

<h3>Pattern matching Expressions</h3>

<p>
Having made these changes, we can now define <em>rewrite rules</em> that specify how certain subtrees in the AST should be matched (the pattern) and how their substrings should be replaced (the transformation). 
Patterns look like normal code from your language, but may include metavariables that are delimited by the <code>&lt;patternToken&gt;</code>. 
</p>
<p>
For example, <code>`a` + 1</code> is a pattern that matches any expression followed by <code>+ 1</code>. 
The metavariable is <code>a</code>; when the pattern matches, <code>a</code> will be bound to the AST node of the expression that is followed by <code>+1</code>.
</p>
<p>
To rewrite the matches of the pattern in our program, we must supply a transformation, which can contain the metavariables present in the pattern.
A crucial distinction is that the metavariables are now instantiated with their corresponding to their matched subtree.
After the transformation, a new string is returned with the program appropriately rewritten where the pattern was matched.  
</p>
<p>
For example, if we are searching for the pattern <code>`a` + 1</code>, we can supply a replacement expression like <code>1 + `a`</code>.
This pattern will match <code>(3 + 4) + 1</code>.
When we perform the replacement we take the literal <code>1 + </code> part of the string and append the source that was parsed into the subtree that matched <code>`a`</code>.
In this case, this is <code>(3 + 4)</code>, so the replacement text will be <code>1 + (3 + 4)</code>.
</p>

<h3>Example</h3>

<p>
As an example, let's rewrite additions into reverse Polish notation.
Our search pattern is <code>`a` + `b`</code> and our replacement expression is <code>`a` `b` +</code>.
</p>
<figure><pre><code>	| rewriter compositeRewrite rewrite matcher transformation |
	compositeRewrite := SmaCCRewriteFile new.
	compositeRewrite parserClass: CalculatorParser.
	matcher := SmaCCRewriteTreeMatch new.
	matcher source: '`a` + `b`'.
	transformation := SmaCCRewriteStringTransformation new.
	transformation string: '`a` `b` +'.
	rewrite := SmaCCRewrite 
		comment: 'Postfix rewriter' 
		match: matcher
		transformation: transformation.
	compositeRewrite addTransformation: rewrite.
	rewriter := SmaCCRewriteEngine new.
	rewriter rewriteRule: compositeRewrite.
	rewriter rewriteTree: (CalculatorParser parse: '(3 + 4) + (4 + 3)')</code></pre><figcaption></figcaption></figure>

<p>
This code rewrites <code>(3 + 4) + (4 + 3)</code> in RPN format and returns <code>3 4 + 4 3 + +</code>.
The first match that this finds is <code>`a`</code> = <code>(3 + 4)</code> and <code>`b`</code> = <code>(4 + 3)</code>.
Inside our replacement expression, we refer to <code>`a`</code> and <code>`b`</code>, so we first process those expression for more transformations.
Since both contain other additions, we rewrite both expressions to get <code>`a`</code> = <code>3 4 +</code> and <code>`b`</code> = <code>4 3 +</code>.
</p>
<p>
Here's the same example, using SmaCC's special, albeit small rewrite syntax.
</p>
<figure><pre><code>	| rewriter rewriteExpression |
	rewriteExpression := 
		'Parser: CalculatorParser
		&gt;&gt;&gt;`a` + `b`&lt;&lt;&lt;
		-&gt;
		&gt;&gt;&gt;`a` `b` +&lt;&lt;&lt;'.
	rewriter := SmaCCRewriteEngine new.
	rewriter rewriteRule: (SmaCCRewriteRuleFileParser parse: rewriteExpression).
	rewriter rewriteTree: (CalculatorParser parse: '(3 + 4) + (4 + 3)')</code></pre><figcaption></figcaption></figure>

<p>
Note that when you use the same name for multiple metavariables in a pattern, all of these must be equals.
As an example <code>`i` + `i`</code> will only match addition for which the two operands are the same nodes.
</p>

<h3>Parametrizing Transformations</h3>

<p>
Let's extend our RPN rewriter to support other expressions besides addition.
We could do that by providing rewrites for all possible operators (+, -, *, /, ^), but it would be better if we could do it with a pattern.
You might think that we could use <code>`a` `op` `b`</code>, but patterns like <code>`op`</code> will match only expressions corresponding to grammar non-terminals, and not tokens like <code>(+)</code>.
We can tell SmaCC to allow <code>`op`</code> to  match tokens by using <code>`a` `op{beToken}` `b`</code>. Here's the rewrite that works for all arithmetic expressions of the calculator language.
</p>
<figure><pre><code>	Parser: CalculatorParser
	&gt;&gt;&gt;`a` `op{beToken}` `b`&lt;&lt;&lt;
	-&gt;
	&gt;&gt;&gt;`a` `b` `op`&lt;&lt;&lt;</code></pre><figcaption></figcaption></figure>

<p>
If we transform <code>(3 + 4) * (5 - 2) ^ 3</code>, we'll get <code>3 4 + 5 2 - 3 ^ *</code>.
Notice that SmaCC has performed three transformations using the same pattern-matching rule.
</p>

<h3>Restrictions and Limitations</h3>

<p>
At present, SmaCC's rewriting facility can generate only text, not parse trees.
In other words, although you can and should think of SmaCC's rewrites as matching a parse tree,
they cannot produce a modified parse tree, only modified source code.
However, if you want to write node rewrites in Smalltalk, <code>SmaCCParseNode</code> has some useful primitives to replace or add nodes to the tree.
</p>


  </section>

</article>

<footer>

<div class="footline">
    <div class="github-link">
      <a href="" target="blank"><i class="fa fa-code-fork"></i>Github</a>
    </div>
  </div>
</footer>

<script src="/booklet-Smacc/html/_support/html/js/clipboard.min.js"></script>

<link href="/booklet-Smacc/html/_support/html/css/featherlight.min.css" rel="stylesheet">
<script src="/booklet-Smacc/html/_support/html/js/featherlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script src="/booklet-Smacc/html/_support/html/js/flex.js"></script>
<!-- Prettify annotated paragraphs-->
    <script src="/booklet-Smacc/html_support/html/js/annotated-paragraphs.js"></script>

  </body>
</html>
