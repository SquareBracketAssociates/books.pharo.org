<!DOCTYPE html>
<html>
  <head>
    <title></title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="shortcut icon" href="images/favicon.png" type="image/x-icon" />
<link href="/booklet-Scraping/html/_support/html/css/font-awesome.min.css" rel="stylesheet">
<link href="/booklet-Scraping/html/_support/html/css/nucleus.css" rel="stylesheet">
<link href="/booklet-Scraping/html/_support/html/css/flex.css" rel="stylesheet">
<link rel="stylesheet" href="/booklet-Scraping/html/_support/html/highlightjs/styles/default.css">
<link rel="stylesheet" href="/booklet-Scraping/html/_support/html/css/highlight-commands.css">
<link rel="stylesheet" href="/booklet-Scraping/html/_support/html/css/bootstrap.min.css">
<script src="/booklet-Scraping/html/_support/html/js/jquery-2.x.min.js"></script>
<script src="/booklet-Scraping/html/_support/html/highlightjs/highlight.pack.js"></script>
<script src="/booklet-Scraping/html/_support/html/js/highlight-commands.js"></script>
<meta name="description" content="">
<meta name="author" content="StÃ©phane Ducasse and Peter Kenny">
  </head>
  <body>
    <header>
  <div class="logo">
    <a class="baselink" href="/booklet-Scraping/html"></a>
  </div>
  <div class="burger"><a href="javascript:void(0);" style="font-size:15px;">&#9776;</a></div>
  
</header>
<article>
  <aside>
    <ul class="menu">
   		<li data-nav-id="123" class="dd-item">
    		<a href="/booklet-Scraping/html">
		       <i class="fa fa-fw fa-home"></i>
	    	</a>
        </li>

		
		  <li class="dd-item  haschildren ">
			<div>
			  <a href="/booklet-Scraping/html/Chapters/XPath.html#little journey into xpath">
					Little Journey into XPath
			  </a>
			   <i class="fa fa-angle-right fa-lg category-icon"></i> 
			</div>
			  <ul class="dd-item">
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Scraping/html/Chapters/XPath.html#getting started">
							Getting started
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Scraping/html/Chapters/XPath.html#an example">
							An example
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Scraping/html/Chapters/XPath.html#creating a tree of objects">
							Creating a tree of objects
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Scraping/html/Chapters/XPath.html#nodes, node sets and atomic values">
							Nodes, node sets and atomic values
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Scraping/html/Chapters/XPath.html#basic tree relationships">
							Basic tree relationships
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Scraping/html/Chapters/XPath.html#a large example">
							A large example
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item  haschildren ">
					<div>
						<a href="/booklet-Scraping/html/Chapters/XPath.html#node selection">
							Node selection
						</a>
						<i class="fa fa-angle-right fa-lg category-icon"></i>
					</div>

					<ul class="dd-item">
							
						<li class="dd-item">
							<a href="/booklet-Scraping/html/Chapters/XPath.html#node tag name selection">Node tag name selection</a>
						</li>
							
						<li class="dd-item">
							<a href="/booklet-Scraping/html/Chapters/XPath.html#context and parent">Context and parent</a>
						</li>
							
						<li class="dd-item">
							<a href="/booklet-Scraping/html/Chapters/XPath.html#matching path-based child nodes">Matching path-based child nodes</a>
						</li>
							
						<li class="dd-item">
							<a href="/booklet-Scraping/html/Chapters/XPath.html#matching deep nodes">Matching deep nodes</a>
						</li>
							
						<li class="dd-item">
							<a href="/booklet-Scraping/html/Chapters/XPath.html#identifying attributes">Identifying attributes</a>
						</li>
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item  haschildren ">
					<div>
						<a href="/booklet-Scraping/html/Chapters/XPath.html#predicates">
							Predicates
						</a>
						<i class="fa fa-angle-right fa-lg category-icon"></i>
					</div>

					<ul class="dd-item">
							
						<li class="dd-item">
							<a href="/booklet-Scraping/html/Chapters/XPath.html#first element">First element</a>
						</li>
							
						<li class="dd-item">
							<a href="/booklet-Scraping/html/Chapters/XPath.html#other position functions">Other position functions</a>
						</li>
							
						<li class="dd-item">
							<a href="/booklet-Scraping/html/Chapters/XPath.html#selecting based on node value">Selecting based on node value</a>
						</li>
							
						<li class="dd-item">
							<a href="/booklet-Scraping/html/Chapters/XPath.html#selecting nodes based on attribute value">Selecting nodes based on attribute value</a>
						</li>
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Scraping/html/Chapters/XPath.html#selecting unknown nodes">
							Selecting Unknown Nodes
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Scraping/html/Chapters/XPath.html#handling multiple queries">
							Handling multiple queries
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item  haschildren ">
					<div>
						<a href="/booklet-Scraping/html/Chapters/XPath.html#xpath axes">
							XPath axes
						</a>
						<i class="fa fa-angle-right fa-lg category-icon"></i>
					</div>

					<ul class="dd-item">
							
						<li class="dd-item">
							<a href="/booklet-Scraping/html/Chapters/XPath.html#paths ">Paths </a>
						</li>
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Scraping/html/Chapters/XPath.html#conclusion">
							Conclusion
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
			  </ul>
		  
		  </li>
		
		  <li class="dd-item  haschildren ">
			<div>
			  <a href="/booklet-Scraping/html/Chapters/Scraping.html#scraping html">
					Scraping HTML
			  </a>
			   <i class="fa fa-angle-right fa-lg category-icon"></i> 
			</div>
			  <ul class="dd-item">
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Scraping/html/Chapters/Scraping.html#getting started">
							Getting started
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Scraping/html/Chapters/Scraping.html#define the problem">
							Define the Problem
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Scraping/html/Chapters/Scraping.html#first find the required data">
							First find the required data
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Scraping/html/Chapters/Scraping.html#going back to our problem">
							Going back to our problem
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Scraping/html/Chapters/Scraping.html#turning the pages">
							Turning the pages
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Scraping/html/Chapters/Scraping.html#conclusion ">
							Conclusion 
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
			  </ul>
		  
		  </li>
		
		  <li class="dd-item  haschildren ">
			<div>
			  <a href="/booklet-Scraping/html/Chapters/Scraping2.html#scraping magic ">
					Scraping Magic 
			  </a>
			   <i class="fa fa-angle-right fa-lg category-icon"></i> 
			</div>
			  <ul class="dd-item">
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Scraping/html/Chapters/Scraping2.html#getting a tree">
							Getting a tree
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item  haschildren ">
					<div>
						<a href="/booklet-Scraping/html/Chapters/Scraping2.html#first the card visual ">
							First the card visual 
						</a>
						<i class="fa fa-angle-right fa-lg category-icon"></i>
					</div>

					<ul class="dd-item">
							
						<li class="dd-item">
							<a href="/booklet-Scraping/html/Chapters/Scraping2.html#no so cool but working... ">No so cool but working... </a>
						</li>
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Scraping/html/Chapters/Scraping2.html#revisiting it">
							Revisiting it
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Scraping/html/Chapters/Scraping2.html#getting data">
							Getting data
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
		   	  	<li class="dd-item ">
					<div>
						<a href="/booklet-Scraping/html/Chapters/Scraping2.html#conclusion">
							Conclusion
						</a>
						
					</div>

					<ul class="dd-item">
					
					</ul>						
				</li>
				
			  </ul>
		  
		  </li>
		
    </ul>
  </aside>

  <section class="page">
    
	<h1>Scraping HTML with XPath</h1>
		
	<h2>Scraping Magic </h2>

<p>
In this chapter we will scrap the web site of Magic the gathering and in particular the card database. (Yes I play Magic not super good but well I have fun). 
Here is one example <a href="http://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=389430">http://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=389430</a>  as shown in Figure <a href="#ligthouse2"></a>.
Now we will try to show you how we explore the HTML page using the excellent Pharo inspector: diving in the tree nodes and checking live their attributes or children is simply super cool.
</p>

<p>
<a id="ligthouse2"></a>
<figure>
	<img src="figures/arcane.png" width="80%" id="ligthouse2" alt="http://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=389430."/>
	<figcaption>http://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=389430.</figcaption>
</figure>
</p>
<h3>Getting a tree</h3>

<p>
The first thing was to make sure that we can get a tree from the web page. For this task we used the <code>XMLHTMLParser</code> class and sends it the message <code>parseURL:</code>. How did we find this message... Simply looking on the class side methods of the class. 
How did we find the class, well looking at the subclass of <code>XMLDOMParser</code> because HTML is close to XML or the inverse :).  
</p>
<figure><pre><code>| tree |
tree := (XMLHTMLParser parseURL: 'http://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=389430') </code></pre><figcaption></figcaption></figure>



<h3>First the card visual </h3>

<p>
First we would like to grab the card visual because this is fun and cool. When we open the card visual in a separate window we see that the url is <a href="http://gatherer.wizards.com/Handlers/Image.ashx?multiverseid=389430&type=card">http://gatherer.wizards.com/Handlers/Image.ashx?multiverseid=389430&type=card</a>. Therefore we started to look for Handlers in the nodes as shown in Figure <a href="#image0"></a>.
</p>

<p>
<a id="image0"></a>
<figure>
	<img src="figures/magic1.png" width="80%" id="image0" alt="Exploring images."/>
	<figcaption>Exploring images.</figcaption>
</figure>
</p>
<figure><pre><code>| tree |
tree := (XMLHTMLParser parseURL: 'http://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=389430').
tree xpath: '//img'	</code></pre><figcaption></figcaption></figure>



<h4>No so cool but working... </h4>

<p>
Toying with the inspector, we come up with the following ugly expression to get the name of the JPEG
</p>
<figure><pre><code>| tree |
tree := (XMLHTMLParser parseURL: 'http://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=389430').
((tree xpath: '//img') third @ 'src') first value allButFirst: 5
&gt;&gt;&gt; 'Handlers/Image.ashx?multiverseid=389430&amp;type=card'</code></pre><figcaption></figcaption></figure>

<p>
Ugly isn't it? This happens often when scraping HTML, but we can do better. 
By the way note also that we start to enter directly XPath command using the XPath pane and using the doit and go facilities of the inspector. 
This way we do not have to get the page from internet all the time. 
</p>

<h3>Revisiting it</h3>

<p>
We could not really show you such ugly expressions so we had to find a better one.
</p>
<p>
So first we look at the img that has src as atttribute as shown below and in Figure <a href="#image1"></a>.
</p><figure><pre><code>| tree |
tree := (XMLHTMLParser parseURL: 'http://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=389430').
(tree xpath: '//img[@src]')</code></pre><figcaption></figcaption></figure>

<p>
<a id="image1"></a>
<figure>
	<img src="figures/magic2.png" width="80%" id="image1" alt="Exploring images."/>
	<figcaption>Exploring images.</figcaption>
</figure>
</p>
<p>
Then as shown in Figure <a href="#image2"></a> we inspected the right node.
 
<a id="image2"></a>
<figure>
	<img src="figures/magic3.png" width="80%" id="image2" alt="Narrowing the node."/>
	<figcaption>Narrowing the node.</figcaption>
</figure>
</p>
<p>
Finally since we were on this exact node, we looked in its class to see if we could get an API to get the attribute in a nice way as shown in Figure <a href="#image3"></a>.
</p>
<p>
<a id="image3"></a>
<figure>
	<img src="figures/magic4.png" width="80%" id="image3" alt="Exploring the class API on the spot: looking to see if there is a attribute something method."/>
	<figcaption>Exploring the class API on the spot: looking to see if there is a attribute something method.</figcaption>
</figure>
</p>
<figure><pre><code>| tree |
tree := (XMLHTMLParser parseURL: 'http://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=389430').
(tree xpath: '//img[@src]') third attributeAt: 'src'</code></pre><figcaption></figcaption></figure>

<p>
Now that we have the visual path, we can use the HTTP client of Pharo to get the image as shown in Figure <a href="#zinc"></a>.
</p>
<figure><pre><code>| tree path |
tree := (XMLHTMLParser parseURL: 'http://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=389430').
path := ((tree xpath: '//img[@src]')	third attributeAt: 'src') allButFirst: 5.
(ZnEasy getJpeg: 'http://gatherer.wizards.com/',path) asMorph openInWorld</code></pre><figcaption></figcaption></figure>

<p>
<a id="zinc"></a>
<figure>
	<img src="figures/magic5.png" width="100%" id="zinc" alt="Getting the card visual inside Pharo."/>
	<figcaption>Getting the card visual inside Pharo.</figcaption>
</figure>
</p>
<h3>Getting data</h3>

<p>
Since this web page is probably generated, we look for example for the artist string in the source and we found the following matches:
</p>
<figure><pre><code>ClientIDs.artistRow = 'ctl00_ctl00_ctl00_MainContent_SubContent_SubContent_artistRow';</code></pre><figcaption></figcaption></figure>

<p>
This one is more interesting:
</p>
<figure><pre><code>&lt;div id=&quot;ctl00_ctl00_ctl00_MainContent_SubContent_SubContent_artistRow&quot; class=&quot;row&quot;&gt;
   &lt;div class=&quot;label&quot;&gt;
       Artist:&lt;/div&gt;
   &lt;div id=&quot;ctl00_ctl00_ctl00_MainContent_SubContent_SubContent_ArtistCredit&quot; class=&quot;value&quot;&gt;
     &lt;a href=&quot;/Pages/Search/Default.aspx?action=advanced&amp;amp;artist=[%22Igor Kieryluk%22]&quot;&gt;Igor Kieryluk&lt;/a&gt;&lt;/div&gt;</code></pre><figcaption></figcaption></figure>

<p>
We can build queries to identify node elements having this id.
To avoid to perform an internet request each time, we typed directly XPath path in the XPath pane of the inspector as shown in Figure <a href="#row"></a>.
Now trying to get faster we looked at all the class=&quot;row&quot; as shown in Figure <a href="#row"></a>.
</p>
<figure><pre><code>//div[@class='row']</code></pre><figcaption></figcaption></figure>

<p>
<a id="row"></a>
<figure>
	<img src="figures/magic6.png" width="80%" id="row" alt="Getting the card information."/>
	<figcaption>Getting the card information.</figcaption>
</figure>
</p>
<p>
The following expression returns the pair label and value for example for the card name label and its value.
</p>
<figure><pre><code>//div[@class='row']/div[@class='label']| //div[@class='row']/div[@class='value']</code></pre><figcaption></figcaption></figure>

<p>
So we can now query all the fields
</p>
<figure><pre><code>| tree |
tree := (XMLHTMLParser parseURL: 'http://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=389430').
container := tree xpath: '//div[@class=''row'']/div[@class=''label'']| //div[@class=''row'']/div[@class=''value'']'.
container collect: [ :each | each contentString trimBoth  ].
&gt;&gt;&gt; a XMLOrderedList('Card Name:' 'Arcane Lighthouse' 'Types:' 'Land' 'Card Text:' 
': Add  to your mana pool. , : Until end of turn, creatures your opponents control 
lose hexproof and shroud and can''t have hexproof or shroud.' 
'Expansion:' 'Commander 2014' 'Rarity:' 'Uncommon' 'Card Number:' '59' 'Artist:' 'Igor Kieryluk')</code></pre><figcaption></figcaption></figure>

<p>
Now we can convert this into a dictionary 
</p>
<figure><pre><code>| tree  |
tree := (XMLHTMLParser parseURL: 'http://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=389430').
container := tree xpath: '//div[@class=''row'']/div[@class=''label'']| //div[@class=''row'']/div[@class=''value'']'.
((container collect: [ :each | each contentString trimBoth  ])
	asOrderedCollection groupsOf: 2 atATimeCollect: [ :x :y | x -&gt; y]) asDictionary</code></pre><figcaption></figcaption></figure>


<p>
And convert it into JSON for fun
</p>
<figure><pre><code>| tree dict |
tree := (XMLHTMLParser parseURL: 'http://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=389430').
container := tree xpath: '//div[@class=''row'']/div[@class=''label'']| //div[@class=''row'']/div[@class=''value'']'.
dict := ((container collect: [ :each | each contentString trimBoth  ])
	asOrderedCollection groupsOf: 2 atATimeCollect: [ :x :y | x -&gt; y]) asDictionary.
	
NeoJSONWriter toStringPretty:dict
&gt;&gt;&gt;	

'{
	&quot;Card Number:&quot; : &quot;59&quot;,
	&quot;Card Name:&quot; : &quot;Arcane Lighthouse&quot;,
	&quot;Artist:&quot; : &quot;Igor Kieryluk&quot;,
	&quot;Types:&quot; : &quot;Land&quot;,
	&quot;Card Text:&quot; : &quot;: Add  to your mana pool. , : Until end of turn, creatures your opponents control lose
	 hexproof and shroud and can''t have hexproof or shroud.&quot;,
	&quot;Expansion:&quot; : &quot;Commander 2014&quot;,
	&quot;Rarity:&quot; : &quot;Uncommon&quot;
}'</code></pre><figcaption></figcaption></figure>

<p>
Now we can apply the same technique to access all the cards and also different pages to extract all the card unique id and query the database. 
But this is left as an exercise.
</p>
<h3>Conclusion</h3>

<p>
We show you how we could access the page and navigate interactively through it using XPath and live programming feature of Pharo.
This chapter should show the great value to be able to tweak you live a document and navigate to find the information you really want.

</p>

  </section>

</article>

<footer>

<div class="footline">
    <div class="github-link">
      <a href="" target="blank"><i class="fa fa-code-fork"></i>Github</a>
    </div>
  </div>
</footer>

<script src="/booklet-Scraping/html/_support/html/js/clipboard.min.js"></script>

<link href="/booklet-Scraping/html/_support/html/css/featherlight.min.css" rel="stylesheet">
<script src="/booklet-Scraping/html/_support/html/js/featherlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script src="/booklet-Scraping/html/_support/html/js/flex.js"></script>
<!-- Prettify annotated paragraphs-->
    <script src="/booklet-Scraping/html_support/html/js/annotated-paragraphs.js"></script>

  </body>
</html>
